# 1단계. 문제 이해 및 설계 범위 확정

### 고려할 사항

- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성, 그리고 안정성
- 지원 클라이언트: 모바일 앱, 웹브라우저, 그리고 스마트 TV

# 2단계. 개략적 설계안 제시 및 동의 구하기

### CDN과 BLOB 스토리지를 직접 만들지 않는 이유

- 시스템 설계 면접은 밑바닥부터 만드는 것이 아닌 적절한 기술을 골라 설계를 마치는 것
- 규모 확장이 쉬운 BLOB 저장소나 CDN을 만드는 것은 많은 비용이 드는 일. 큰 회사도 모든 것을 스스로 구축하지 않음

### 컴포넌트

- 단말
- CDN
- API 서버

## 비디오 업로드 절차

### 비디오 업로드

1. 비디오를 원본 저장소에 업로드한다.
2. 트랜스코딩 서버는 원본 저장소에서 해당 비디오를 가져와 트랜스코딩한다.
3. 트랜스 코딩이 완료되면 아래 두 절차가 병렬적으로 수행
    1. 완료된 비디오를 트랜스코딩 비디오 저장소로 업로드
    2. 트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣는다.
        1. 트랜스 코딩이 끝난 비디오를 CDN에 올린다.
        2. 완료 핸들러가 이벤트 데이터를 큐에서 꺼낸다.
        3. 완료 핸들러가 메타데이터 데이터 베이스와 캐시를 갱신한다.
4. API 서버가 단말에게 업로드가 끝나 스트리밍 준비가 완료되었음을 알린다.

### 메타데이터 갱신

원본 저장소에 파일이 업로드되는 동안, 단말은 병렬적으로 비디오 메타데이터 갱신 요청을 API 서버에 보낸다.

API는 이 정보로 메타데이터 캐시와 데이터베이스를 업데이트 한다.

## 비디오 스트리밍 절차

### 스트리밍 프로토콜

비디오 스트리밍을 위해 데이터를 전송할 때 쓰이는 표준화된 통신 방법

프로토콜마다 지원하는 비디오 인코딩이 다르고 플레이어도 다르다

- MPEG-DAST
- 애플 HLS
- 마이크로소프트 스무드 스트리밍
- 어도비 HTTP 동적 스트리밍

비디오는 CDN에서 바로 스트리밍 된다. 사용자의 단말에 가장 가까운 CDN 서버가 비디오 전송 담당

# 3단계. 상세 설계

## 비디오 트랜스코딩

비디오가 다른 단말에서도 순조롭게 재생되려면 다른 단말과 호환되는 비트레이트와 포맷으로 저장되어야 한다.

- **비트 레이트**
    
    비디오를 구성하는 비트가 얼마나 빨리 처리되어야 하는지 나타내는 단위
    
    높은 비디오는 고화질 비디오, 높은 성능의 컴퓨팅 파워가 필요하고 인터넷 회선속도도 빨라야 한다.
    

### 비디오 트랜스코딩의 중요성

- 가공되지 않은 원본 비디오는 저장 공간을 많이 차지한다.
- 상당수의 단말과 브라우저는 특정 종류의 비디오 포맷만 지원한다. 따라서 여러 포맷으로 인코딩해두어야 함
- 끊김 없는 고화질 비디오 재생을 보장하려면 사용자에 따라 저화질, 고화질 비디오를 적절히 전송해야 한다.
- 모바일 단말의 경우 네트워크 상황이 수시로 변경될 수 있다.

### 인코딩 포맷

- 컨테이너: 비디오 파일, 오디오, 메타데이터를 담는 바구니같은 것
- 코덱: 비디오 화질은 보존하면서 파일 크기를 줄일 목적으로 고안된 압축 및 압축 해제 알고리즘

## 유향 비순환 그래프(DAG) 모델

### 비디오 부분에 적용되는 작업

- 검사: 좋은 품질의 비디오인지, 손상은 없는지 확인하는 작업
- 비디오 인코딩: 비디오를 다양한 해상도, 코덱, 비트레이트 조합으로 인코딩하는 작업
- 섬네일: 사용자가 업로드한 이미지나 비디오에서 자동 추출된 이미지로 섬네일을 만드는 작업
- 워터마크: 비디오에 대한 식별정보를 이미지 위에 오버레이 형태로 띄워 표시하는 작업

## 비디오 트랜스코딩 아키텍처

### 전처리기

- **비디오 분할**
    
    비디오 스트림을 GOP라고 불리는 단위로 쪼갠다
    
    GOP를 지원하지 않는 경우 전처리기가 비디오 분할을 대신 함
    
    - GOP: 특정 순서로 배열된 프레임 그룹, 독립적으로 재생 가능하며 보통 초단위
- **DAG 생성**
    
    클라이언트 프로그래머가 작성한 설정 파일에 따라 DAG 생성
    
- **데이터 캐시**
    
    전처리기는 분할된 비디오의 캐시이기도 하다.
    
    안정성을 높이기 위해 GOP와 메타 데이터를 임시저장소에 보관한다.
    
    인코딩이 실패하면 보관된 데이터를 이용해 인코딩 재개
    

### DAG 스케줄러

DAG 그래프를 분할한 다음에 자원 관리자의 작업 큐에 집어넣는다.

### 자원 관리자

자원 배분을 효과적으로 수행하는 역할을 담당

세 개의 큐와 작업 스케줄러로 구성됨

- 작업 큐: 실행할 작업이 보관되어 있는 우선순위 큐
- 작업 서버 큐: 작업 서버의 가용 상태 정보가 보관되어 있는 우선순위 큐
- 실행 큐: 현재 실행 중인 작업 및 작업 서버 정보가 보관되어 있는 큐
- 작업 스케쥴러: 최적의 작업/서버 조합을 골라 해당 작업 서버가 작업을 수행하도록 지시

### 작업 실행 서버

DAG에 정의된 작업 수행

작업 종류에 따라 작업 서버도 구분하여 관리

### 임시 저장소

어떤 시스템을 선택할 것이냐는 저장할 데이터의 유형, 크기, 이용 빈도, 데이터 유효 기간등에 따라 달라진다.

### 인코딩된 비디오

인코딩 파이프라인의 최종 결과물

## 시스템 최적화

### 속도 최적화: 비디오 병렬 업로드

비디오를 전부 한 번의 업로드로 올리는 것은 비효율적이므로 GOP들로 분할하여 올린다.

일부가 실패해도 빠르게 업로드 제개 가능

### 속도 최적화: 업로드 센터를 사용자 근거리에 지정

업로드 센터를 여러곳에 둔다.

### 속도 최적화: 모든 절차를 병렬화

낮은 응답지연 달성을 위해 느슨하게 결합된 시스템을 만들어서 병렬성을 높인다.

메세지 큐를 도입하여 시스템 결합도를 낮출 수 있다.

### 안정성 최적화: 미리 사인된 업로드 URL

허가받은 사용자만이 올바른 장소에 비디오를 업로드할 수 있도록 하기 위해, 미리 사인된 업로드 URL을 이용한다.

### 안정성 최적화: 비디오 보호

**비디오의 저작권 보호를 위한 선택지**

- 디지털 저작권 관리 시스템 도입
- AES 암호화
- 워터마크

### 비용 최적화

1. 인기 비디오는 CDN을 통해 재생하되 다른 비디오는 비디오 서버를 통해 재생
2. 인기가 별로 없는 비디오는 인코딩 할 필요가 없을 수도 있음, 짧은 비디오는 필요할 때 인코딩하여 재생할 수 있다
3. CDN을 직접 구축하고 인터넷 서비스 제공자와 제휴한다.

## 오류 처리

### 시스템 오류 종류

- 회복 가능 오류: 몇 번 재시도 후 실패시 클라이언트에게 오류 코드 반환
- 회복 불가능 오류: 작업 중단 후 클라이언트에게 오류 코드 반환

### 오류에 대한 전형적인 해결 방법

- 업로드 오류: 몇 회 재시도
- 비디오 분할 오류: GOP 경계에 따라 비디오를 분할하지 못하는 경우라면 전체 비디오를 서버로 전송하여 서버가 분할 처리하도록 함
- 트랜스코딩 오류: 재시도
- 전처리 오류: DAG 그래프 재생성
- DAG 스케쥴러 오류: 작업을 다시 스케쥴링
- 자원 관리자 큐에 장애 발생: 사본 이용
- 작업 서버 장애: 다른 서버에서 해당 작업을 재시도

# 4단계. 마무리

### 더 논의해 볼 사항

- API 계층의 규모 확장성 확보 방안
- 데이터베이스 계층의 규모 확장성 확보 방안
- 라이브 스트리밍
- 비디오 삭제
