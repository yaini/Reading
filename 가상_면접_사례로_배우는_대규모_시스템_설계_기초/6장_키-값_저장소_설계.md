### 키-값 저장소

키-값 데이터베이스라고도 불리는 비 관계형 데이터베이스

# 문제 이해 및 설계 범위 확정

# 단일 서버 키-값 저장소

### 해시테이블

- 빠른 속도 보장
- 모든 데이터를 메모리 안에 두는 것은 불가능
- 해결책: 데이터 압축, 자주 쓰는 데이터만 메모리 저장

# 분산 키-값 저장소

키-값 쌍을 여러 서버에 분산시키기 때문에 분산 해시 테이블이라고 불림

## CAP 정리

- 일관성: 모든 클라이언트는 어떤 노드에 접속했느냐에 관계없이 항상 같은 데이터를 조회해야 한다.
- 가용성: 일부 노드에 장애가 발생하더라도 항상 응답을 받을 수 있어야 한다.
- 파티션 감내: 네트워크에 파티션이 생기더라도 시스템은 계속 동작하여야 한다.

분산 시스템에선 세가지 요구사항을 동시에 만족할 수 없음

- CP 시스템: 일관성과 파티션 감내 지원
- AP 시스템: 가용성과 파티션 감내 지원
- CA 시스템: 일관성과 가용성을 지원, 하지만 네트워크 장애는 피할 수 없으므로 실세계엔 존재하지 않음

### 실세계의 분산시스템

CP시스템에선 네트워크 파티션 때문에 일관성이 깨질 수 있는 상황이라면 해결될 때까지 오류 반환

AP 시스템에션 낡은 데이터를 반환할 위험이 있더라도 읽기 연산 허용

## 시스템 컴포넌트

### 데이터 파티션

데이터를 작은 파티션들로 분할한 다음 여러 대 서버에 저장

- 데이터를 여러 서버에 고르게 분산할 수 있는가
- 노드가 추가되거나 삭제될 때 데이터의 이동을 최소화할 수 있는가

**안정 해시를 사용하여 데이터를 파티션하면 좋은 점**

- 규모 확장 자동화
- 다양성

### 데이터 다중화

데이털르 N개의 서버에 비동기적으로 다중화 (N은 튜닝 가능한 값)

키를 해시 링 위에 배치한 후 그 지점으로부터 시계 방향으로 링을 순회하면서 만나는 첫 N개 서버에 데이터 사본 저장

가상 노드를 사용한다면 같은 물리 서버를 중복 선택하지 않도록 주의

### 데이터 일관성

다중화된 데이터는 적절히 동기화가 되어야 함

정족수 합의 프로토콜을 사용하면 읽기/쓰기 연산 모두에 일관성 보장

- N: 사본 개수
- W: 쓰기 연산에 대한 정족수. 쓰기 연산이 성공한 것으로 간주되려면 적어도 W개의 서버로부터 쓰기 연산이 성공했다는 응답을 받아야 한다.
- R: 읽기 연산에 대한 정족수. 읽기 연산이 성공한 것으로 간주되려면 적어도 R개의 서버로부터 응답을 받아야 한다.

W+R > N인 경우엔 강한 일관성 보장

**일관성 모델**

- 강한 일관성
    - 모든 읽기 연산은 가장 최근에 갱신된 결과를 반환
    - 모든 사본에 결과가 반영될 때까지 데이터에 대한 읽기/쓰기 금지
- 약한 일관성
    - 가장 최근에 갱신된 결과를 반환하지 못할 수 있음
- 최종 일관성
    - 갱신 결과가 결국에는 모든 사본에 반영되는 모델
    - 버전 정보를 활용해 일관성이 깨진 데이터를 읽지 않도록 함

**비 일관성 해소 기법: 데이터 버저닝**

- 벡터 시계: [서버, 버전]의 순서쌍을 데이터에 매단 것
    - D: 데이터, v: 버전 카운터, S: 서버 번호
    - [Si, vi]가 있으면 vi 증가, 그렇지 않으면 [Si, 1] 만듬
    - 버전 비교시 구성 요소의 값보다 같거나 큰지 판단
    - 단점
        - 충돌 감지 및 해소 로직이 클라이언트에 들어가야 하므로 클라이언트 구현이 복잡해짐
        - [서버, 버전]의 순서쌍 개수가 굉장히 빨리 늘어남

**장애 감지**

가십 프로토콜

- 분산형 장애 감지 솔루션
- 박동 카운터 값이 지정된 시간 동안 갱신되지 않으면 장애인 것으로 간주

**일시적 장애 처리**

- 임시 위탁 기법
    - 네트워크나 서버 문제로 장애 상태인 서버로 가는 요청은 다른 서버가 잠시 맡아 처리
    - 그동안 발생한 변경사항은 서버가 복구되었을 때 일괄 반영하여 데이터 일관성 보존
    - 임시로 쓰기 연산을 처리한 서버에는 hint를 남겨 둠

**영구 장애 처리**

- 반-엔트로피 프로토콜
    - 사본들을 비교하여 최신 버전으로 갱신하는 과정 포함
    - 일관성이 어긋난 상태를 탐지하기 위해 머클 트리 사용
        - 루트 노드의 해시 값이 일치한다면 두 서버는 같은 데이터를 가짐
        - 다르다면 아래쪽으로 탐색해나가면서 변경된 부분만 동기화

## 시스템 아키텍처 다이어그램

### 쓰기 경로

- 쓰기 요청이 커밋 로그 파일에 기록
- 데이터가 메모리 캐시에 기록
- 메모리 캐시가 임계치에 도달하면 데이터는 디스크에 있는 SSTable에 기록

### 읽기 경로

캐시를 탐색한 후 없는 경우 블룸 필터를 이용해 디스크에서 가져옴
