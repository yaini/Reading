## 컨테이너 이미지 생성하기

### 어플리케이션 생성

```jsx
const http = require('http');
const os = require('os');

console.log('Kubia server starting...');

var handler = function(request, response){
	console.log('Received requset from '+request.connection.remoteAddress);
	response.writeHead(200);
	response.end("You've hit"+os.hostname()+"\n");
};

var www = http.createServer(handler);
www.listen(8080);
```

어플리케이션이 잘 실행되고 있는지 확인할 nodejs파일을 생성해본다.

간단하게 요청이 오면 hostname을 출력하는 웹 어플리케이션이다.

### 도커 명령어 설정

```docker
FROM node:7
ADD app.js /app.js
ENTRYPOINT ["node", "app.js"]
```

어플리케이션을 도커에서 실행시킬 이미지로 패키징하기 위해선 일련의 명령들이 필요하다.

이 명령들을 모아놓은 파일이 Dockerfile

### 컨테이너 이미지 생성

```bash
$ docker build -t kubia .
[+] Building 1.0s (7/7) FINISHED
 => [internal] load build definition from Dockerfile                                                           0.0s
 => => transferring dockerfile: 42B                                                                            0.0s
 => [internal] load .dockerignore                                                                              0.0s
 => => transferring context: 2B                                                                                0.0s
 => [internal] load metadata for docker.io/library/node:7                                                      0.9s
 => [internal] load build context                                                                              0.0s
 => => transferring context: 385B                                                                              0.0s
 => CACHED [1/2] FROM docker.io/library/node:7@sha256:af5c2c6ac8bc3fa372ac031ef60c45a285eeba7bce9ee9ed66dad3a  0.0s
 => [2/2] ADD app.js /app.js                                                                                   0.0s
 => exporting to image                                                                                         0.0s
 => => exporting layers                                                                                        0.0s
 => => writing image sha256:4a111928985b771b2a2c33b2f9516db4c315fcdf06e82961fb8365de924f82fa                   0.0s
 => => naming to docker.io/library/kubia
```

다음 명령어를 실행하여서 kubia라는 이미지를 만들어 준다.

나는 app.js 를 만들다가 오타가 나서 다시 실행했던 과정인데 첫번째 명령어인 node 이미지를 캐싱을 이용하여 가져오는 것을 볼 수 있다. 도커를 사용하면서 굉장히 장점이라고 생각했던 부분인데 다시 빌드를 할때마다 시간을 굉장히 많이 절약해준다.

### 컨테이너 이미지 실행

```bash
$ docker run --name kubia-container -p 8080:8080 -d kubia                        ok | 16:27:21
251b24fbd94fcc8588d38ac5b7a1bac4fa9d205ec3e8ccea8771f7c963e37e1f
```

kubia 이미지를 이용하여 kubia-container를 생성하는 과정

출력된 해시 값은 container id이다.

### 실행된 어플리케이션 확인

```bash
$ curl localhost:8080                                                            ok | 16:27:24
You've hit251b24fbd94f
```

hostname을 출력하며 잘 실행이 된 것을 확인할 수 있다!

## 이미지 레지스트리에 이미지 푸시

### 이미지 태그 지정

```bash
$ docker tag kubia yaini/kubia
```

### 도커 허브에 이미지 푸시

```bash
$ docker login
$ docker push yaini/kubia                                                  ok | 11s | 16:50:11
Using default tag: latest
The push refers to repository [docker.io/yaini/kubia]
7190e6f18e5a: Pushed
ab90d83fa34a: Mounted from library/node
8ee318e54723: Mounted from library/node
e6695624484e: Mounted from library/node
da59b99bbd3b: Mounted from library/node
5616a6292c16: Mounted from library/node
f3ed6cb59ab0: Mounted from library/node
654f45ecb7e3: Mounted from library/node
2c40c66f7667: Mounted from library/node
latest: digest: sha256:a9634d21f331232990b5416177e1a862290914d252f3f3d12638d2b0907dfc27 size: 2213
```

## 쿠버네티스 클러스터 설치

- Google Cloud Platform 가입 및 프로젝트 만들기
- 쿠버네티스 엔진 API 활성화
- 구글 클라우드 SDK 다운로드 및 설치
- kubectl 설치

와 같은 일련의 과정을 완료하면 쿠버네티스 클러스터를 생성할 수 있다!

### 쿠버네티스 클러스터 생성

```bash
$ gcloud container clusters create kubia --num-nodes 3 --machine-type f1-micro
kubeconfig entry generated for kubia.
NAME   LOCATION           MASTER_VERSION   MASTER_IP     MACHINE_TYPE  NODE_VERSION     NUM_NODES  STATUS
kubia  asia-northeast3-a  1.21.5-gke.1302  34.64.207.54  e2-medium     1.21.5-gke.1302  3          RUNNING
```

와 같이 입력한 후 GCP 콘솔을 확인해보면

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d510f5a4-3a5f-4a99-a5c6-f057b3548762/Untitled.png)

다음과 같이 클러스터 생성이 된 것을 확인할 수 있다. (시간이 꽤 걸린다.)

## 쿠버네티스에서 어플리케이션 실행하기

### 어플리케이션 구동하기

```bash
$ kubectl run kubia --image=yaini/kubia --port=8080 run/v1       
pod/kubia created
```

```bash
$ kubectl get pods                                                  ok | kubia kube | 17:16:45
NAME    READY   STATUS    RESTARTS   AGE
kubia   1/1     Running   0          4m27s
```

파드가 정상적으로 생성된 것을 확인할 수 있다.

### 서비스 오브젝트 생성하기

```bash
$ kubectl expose pod kubia --type=LoadBalancer --name kubia-http    ok | kubia kube | 17:23:08
service/kubia-http exposed
```

```bash
$ kubectl get services                                              ok | kubia kube | 17:23:43
NAME         TYPE           CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE
kubernetes   ClusterIP      10.88.0.1     <none>        443/TCP          12m
kubia-http   LoadBalancer   10.88.6.141   <pending>     8080:30446/TCP   30s
```

조금만 더 기다리면 external-ip도 할당된다!

근데 웨 접속이 안되지..

```bash
$ curl 34.64.126.237:8080                                      ok | 09:28:43
You've hitkubia
```

?????????????????????????

### 레플리케이션 컨트롤러 생성 테스트

```bash
apiVersion: v1
kind: ReplicationController
metadata:
  name: rp 
spec:
  replicas: 3
  selector:
    app: rp
  template:
    metadata:
      name: rp
      labels:
        app: rp
    spec:
      containers:
      - name: rp
        image: yaini/kubia
        ports:
        - containerPort: 8080
```

```bash
$ vi test.yml                                                       28 err | 1m 15s | 17:52:20
$ kubectl apply -f test.yml                                    ok | 6s | kubia kube | 18:03:21
replicationcontroller/nginx created
$ kubectl expose rc rp --type=LoadBalancer --name kubia-http-rp
service/kubia-http-test exposed
```

### 레플리케이션 컨트롤러

파드가 스펙과 동일한 개수가 유지되도록 관리

현재는 레플리카세트, 배포엔 디플로이먼트를 사용한다.

- 레플리카세트
    - 셀렉터를 지원 (레이블 선택에서 다양한 연산자 지원)
- 디플로이먼트
    - 파드 개수 뿐만 아니라 배포 전략 설정 가능

### 에러

- kubectl에서 json 에러
    
    ```bash
    error: couldn't get version/kind; json parse error: json: cannot unmarshal string into Go value of type struct { APIVersion string "json:\"apiVersion,omitempty\""; Kind string "json:\"kind,omitempty\"" }
    ```
    

- 충분한 메모리?
    
    ```bash
    ERROR: (gcloud.container.clusters.create) ResponseError: code=400, message=Node pools of f1-micro machines are not supported due to insufficient memory.
    ```
    

- Error: unknown flag: --generator
    - deprecated 되었다. generator 없이 명령어 실행 가능
